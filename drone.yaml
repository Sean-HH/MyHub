kind: pipeline
type: docker
name: account-service

workspace:
  path: /drone/src

steps:
  - name: "mavenæ‰“åŒ…"
    pull: if-not-exists
    image: maven:3-jdk-8
    volumes:
      - name: cache
        path: /root/.m2
    commands:
      - mvn clean package -P ${env} -U
  - name: "æŽ¨é€Jaræ–‡ä»¶"
    image: appleboy/drone-scp
    pull: if-not-exists
    settings:
      host:
        from_secret: host_${env}
      user:
        from_secret: ssh_user
      key:
        from_secret: ssh_key
      port: 17822
      target: /opt/transfer_station/account-service/
      source: ./target/account-service*.jar
  - name: "é¡¹ç›®å‘å¸ƒ"
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: host_${env}
      user:
        from_secret: ssh_user
      key:
        from_secret: ssh_key
      port: 17822
      script:
        - /bin/sh /usr/script/deploy_account_service.sh

  - name: "ä¼ä¸šå¾®ä¿¡é€šçŸ¥"
    image: fifsky/drone-wechat-work
    pull: if-not-exists
    settings:
      url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=3e47a1b2-1abd-4cce-b469-2de4a7f337b2
      msgtype: markdown
      content: |
        {{if eq .Status "success" }}
        #### ðŸŽ‰ ${DRONE_REPO} æž„å»ºæˆåŠŸ
        > Gitå˜æ›´äº‹é¡¹: [${DRONE_COMMIT_MESSAGE}](${DRONE_COMMIT_LINK})
        > Gitç”¨æˆ·: ${DRONE_COMMIT_AUTHOR}
        > Gitåˆ†æ”¯: ${DRONE_COMMIT_BRANCH}
        > éƒ¨ç½²çŽ¯å¢ƒ: ${env}
        > [ç‚¹å‡»æŸ¥çœ‹](${DRONE_BUILD_LINK})
        {{else}}
        #### âŒ ${DRONE_REPO} æž„å»ºå¤±è´¥
        > Gitå˜æ›´äº‹é¡¹: [${DRONE_COMMIT_MESSAGE}](${DRONE_COMMIT_LINK})
        > Gitç”¨æˆ·: ${DRONE_COMMIT_AUTHOR}
        > Gitåˆ†æ”¯: ${DRONE_COMMIT_BRANCH}
        > éƒ¨ç½²çŽ¯å¢ƒ:  ${env}
        > è¯·ç«‹å³ä¿®å¤!!!
        > [ç‚¹å‡»æŸ¥çœ‹](${DRONE_BUILD_LINK})
        {{end}}
    when:
      status:
      - failure
      - success

volumes:
  - name: cache
    host:
      path: /var/lib/cache
trigger:
  event:
    - custom
